#!/usr/bin/with-contenv sh

. /app/cloudflare.sh #sourcing cloudflare script
. /config/cloudflare.conf # sourcing conf file generated previously (env vars)

# Your Telegram Bot API Token
TOKEN=$YOUR_BOT_TOKEN
# Chat ID of the recipient
CHAT_ID=$RECIPIENT_CHAT_ID

URL="https://api.telegram.org/bot$TOKEN/sendMessage"

DnsIpAddress=$(getDnsRecordIp $CF_ZONE_ID $CF_RECORD_ID)
DiscordWebhookUrl=$WEBHOOK_URL

if [ ! -z ${CUSTOM_LOOKUP_CMD+x} ]; then
  CurrentIpAddress=$(getCustomIpAddress)
elif [ ! -z ${INTERFACE+x} ]; then
  CurrentIpAddress=$(getLocalIpAddress)
else
  CurrentIpAddress=$(getPublicIpAddress)
fi

now=$(date '+%Y-%m-%d %H:%M:%S')
if [ "$DnsIpAddress" == "" ]; then
  echo "ERROR: Failed to determine DNS record $CF_RECORD_NAME ip address."
elif [ "$CurrentIpAddress" != "$DnsIpAddress" ]; then
  echo "$now: Updating CloudFlare DNS record $CF_RECORD_NAME from $DnsIpAddress to $CurrentIpAddress..."
  update=$(updateDnsRecord $CF_ZONE_ID $CF_RECORD_ID $CF_RECORD_NAME $CurrentIpAddress)

  if [ "$update" == "null" ]; then
    msg="$now: ERROR: Failed to update CloudFlare DNS record $CF_RECORD_NAME from $DnsIpAddress to $CurrentIpAddress"
    echo $msg
  else
    webhook -X POST --data "{\"content\": \"$CF_RECORD_NAME updated to $CurrentIpAddress\"}" "$WEBHOOK_URL"
    msg="$now: CloudFlare DNS record $CF_RECORD_NAME ($CurrentIpAddress) updated successfully."
    echo $msg
  fi
  
else
  msg="$now: No DNS update required for $CF_RECORD_NAME ($DnsIpAddress)."
  echo $msg
fi
echo $msg

# For telegram bot
# curl -s -X POST $URL -d chat_id=$CHAT_ID -d text="$msg"
